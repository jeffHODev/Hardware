package com.nivi.nivifilter;

public class SerialBeanFilterEcg {
//    private static final float a[][] = { //ecgfilter bandpass 0.5 - 35Hz fs833
//            {1.00f, -1.85719211550792f, 0.923701967134014f},
//            {1.00f, -1.99883849151285f, 0.998852714396311f},
//            {1.00f, -1.99662705149411f, 0.996641400466275f},
//            {1.00f, -1.73214163360275f, 0.793549189600693f},
//            {1.00f, -1.99467255848571f, 0.994687135103830f},
//            {1.00f, -1.63881386307374f, 0.695932669296446f},
//            {1.00f, -1.99317853386227f, 0.993193358224696f},
//            {1.00f, -1.57741168808446f, 0.631414687251857f},
//            {1.00f, -1.99235794932212f, 0.992372936992724f},
//            {1.00f, -1.54706866082653f, 0.599424058351474f}
//    };

    private static final float a[][] = { //ecgfilter bandpass 0.05 - 35Hz fs833
            {1.00f, -1.85528235172459f, 0.921803530454676f},
            {1.00f, -1.99988223383094f, 0.999882375965657f},
            {1.00f, -1.99965818715830f, 0.999658329423239f},
            {1.00f, -1.72691679565251f, 0.788770663148063f},
            {1.00f, -1.99946685583871f, 0.999466998327878f},
            {1.00f, -1.63097286708356f, 0.689291033787842f},                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            {1.00f, -1.99932715629519f, 0.999327299013740f},
            {1.00f, -1.56771935555782f, 0.623680093393453f},
            {1.00f, -1.99925341382676f, 0.999253556688763f},
            {1.00f, -1.53640266617756f, 0.591187419087585f}
    };

//    private static final float a[][] = { //ecgfilter bandpass 0.05 - 25Hz fs833
//            {1.00f, -1.90880113745816f, 0.943362156797367f},
//            {1.00f, -1.99988231557610f, 0.999882457831324f},
//            {1.00f, -1.99965828416383f, 0.999658426608305f},
//            {1.00f, -1.81108652447821f, 0.843716966619733f},
//            {1.00f, -1.99946664866959f, 0.999466791434723f},
//            {1.00f, -1.73554676438832f, 0.766742297594224f},
//            {1.00f, -1.99932643659838f, 0.999326579691120f},
//            {1.00f, -1.68452071247144f, 0.714727011842106f},
//            {1.00f, -1.99925229773290f, 0.999252441030629f},
//            {1.00f, -1.65888696447294f, 0.688589577839670f}
//    };

    private static final float b[] = { 1.00f, 0.00f, -1.00f }; //第一级二阶滤波，分子

//    private static final float gain[] = { //ecgfilter bandpass 0.5 - 35Hz fs833
//            0.127163086531686f,
//            0.127163086531686f,
//            0.122728534627341f,
//            0.122728534627341f,
//            0.119300481133615f,
//            0.119300481133615f,
//            0.116982580714042f,
//            0.116982580714042f,
//            0.115816929331614f,
//            0.115816929331614f
//    };

    private static final float gain[] = { //ecgfilter bandpass 0.05 - 35Hz fs833
            0.128780457440290f,
            0.128780457440290f,
            0.124237394568045f,
            0.124237394568045f,
            0.120729312887771f,
            0.120729312887771f,
            0.118359150032194f,
            0.118359150032194f,
            0.117167768683121f,
            0.117167768683121f
    };
//private static final float gain[] = { //ecgfilter bandpass 0.05 - 25Hz fs833
//        0.0926126722903531f,
//        0.0926126722903531f,
//        0.0902053975288297f,
//        0.0902053975288297f,
//        0.0882989810643046f,
//        0.0882989810643046f,
//        0.0869873054022591f,
//        0.0869873054022591f,
//        0.0863207468082646f,
//        0.0863207468082646f
//};

    public static float[] m00 = {0};
    public static float[] m01 = {0};

    public static float[] m10 = {0};
    public static float[] m11 = {0};

    public static float[] m20 = {0};
    public static float[] m21 = {0};

    public static float[] m30 = {0};
    public static float[] m31 = {0};

    public static float[] m40 = {0};
    public static float[] m41 = {0};

    public static float[] m50 = {0};
    public static float[] m51 = {0};

    public static float[] m60 = {0};
    public static float[] m61 = {0};

    public static float[] m70 = {0};
    public static float[] m71 = {0};

    public static float[] m80 = {0};
    public static float[] m81 = {0};

    public static float[] m90 = {0};
    public static float[] m91 = {0};

    public static float serialBeanFilter(float x) {
        float y0 = filterOrder2(x, m00, m01, a[0], b, gain[0]);  //第一级二阶滤波
        float y1 = filterOrder2(y0, m10, m11, a[1], b, gain[1]);  //第二级二阶滤波
        float y2 = filterOrder2(y1, m20, m21, a[2], b, gain[2]);  //第二级二阶滤波
        float y3 = filterOrder2(y2, m30, m31, a[3], b, gain[3]);  //第二级二阶滤波
        float y4 = filterOrder2(y3, m40, m41, a[4], b, gain[4]);  //第二级二阶滤波
        float y5 = filterOrder2(y4, m50, m51, a[5], b, gain[5]);  //第二级二阶滤波
        float y6 = filterOrder2(y5, m60, m61, a[6], b, gain[6]);  //第二级二阶滤波
        float y7 = filterOrder2(y6, m70, m71, a[7], b, gain[7]);  //第二级二阶滤波
        float y8 = filterOrder2(y7, m80, m81, a[8], b, gain[8]);  //第二级二阶滤波
        float y9 = filterOrder2(y8, m90, m91, a[9], b, gain[9]);  //第二级二阶滤波

        return y9;
    }
    private static final float na[][] = { //ecgfilter lowpass 0 30 35Hz fs833
            {1.00f, 	-0.999808110794795f, 0.00f},
            {1.00f, 	-1.78145673798700f, 0.833696174671633f},
            {1.00f, 	-1.69804263767020f, 0.747836039309925f},
            {1.00f, 	-1.63551485151022f, 0.683474688373168f},
            {1.00f, 	-1.59400984718431f, 0.640752591316708f},
            {1.00f, 	-1.57334199567885f, 0.619478675741830f},
    };

    private static final float nb[] = {1.00f,  -1.00f, 0.00f };//ecgfilter lowpass 0 30 35Hz fs833
    private static final float ngain[] = { //ecgfilter lowpass 0 30 35Hz fs833
            0.999904055397397f,
            0.0130598591711588f,
            0.0124483504099316f,
            0.0119899592157360f,
            0.0116856860331005f,
            0.0115341700157446f,
    };
    public static float[] n00 = {0};
    public static float[] n01  = {0};

    public static float[] n10 = {0};
    public static float[] n11 = {0};
    public static float[] n20 = {0};
    public static float[] n21  = {0};

    public static float[] n30 = {0};
    public static float[] n31 = {0};
    public static float[] n40 = {0};
    public static float[] n41  = {0};

    public static float[] n50 = {0};
    public static float[] n51 = {0};

    public static float serialBeanFilter1(float x) {
        float y0 = filterOrder2(x, n00, n01, na[0], nb, ngain[0]);  //第一级二阶滤波
        float y1 = filterOrder2(y0, n10, n11, na[1], nb, ngain[1]);  //第二级二阶滤波
        float y2 = filterOrder2(y1, n20, n21, na[2], nb, ngain[2]);  //第一级二阶滤波
        float y3 = filterOrder2(y2, n30, n31, na[3], nb, ngain[3]);
        float y4 = filterOrder2(y3, n40, n41, na[4], nb, ngain[4]);  //第一级二阶滤波
        float y5 = filterOrder2(y4, n50, n51, na[5], nb, ngain[5]);
        return y0;
    }

    /*
    x: input
    m1:保存中间滤波器数据
    m2:保存中间滤波器数据
    a:滤波器系数
    b:滤波器系数
    gain:增益，对于只支持定点小数运算的，需要把增益分配到每个二阶IIR滤波器的系数中，使得每次中间的结果都不溢出，即使其频率响应的最大值最接近0dB
    */
    public static float filterOrder2(float x, float[] m1, float[] m2, float[] a, float[] b, float gain){
        float y, m;
        //计算没有增益的滤波输出，存于y_
        m = x - a[1] * m1[0] - a[2] * m2[0];    //求当前m，同时作为求y_的中间步骤
        y = m + b[1] * m1[0] + b[2] * m2[0];
        //更新*m_1和*m_2
        m2[0] = m1[0];
        m1[0] = m;
        //返回带增益的滤波输出
        return y * gain;
    }
}
